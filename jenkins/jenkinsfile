node {
    stage("Clone the project - GitHub") {
        git 'https://github.com/abhisheksr01/companies-house-microservice-template.git'
    }

    stage("Static Code Analysis - Checkstyle") {
        sh "./gradlew clean check"
    }

    stage("Build - Gradle") {
        sh "./gradlew clean build -x test"
    }

    stage("Unit tests - Junit") {
        try {
            sh "./gradlew test --tests \"com.uk.companieshouse.*\""
        } catch (err) {
            step([$class: 'JUnitResultArchiver', testResults:
                    '**/target/surefire-reports/TEST-*UnitTest.xml'])
            throw err
        }
    }

    stage("Code Coverage - Jacoco") {
        sh "./gradlew jacocoTestReport"
        sh "./gradlew jacocoTestCoverageVerification"

        publishHTML target: [
                allowMissing         : false,
                alwaysLinkToLastBuild: false,
                keepAll              : true,
                reportDir            : 'build/reports/jacocoHtml',
                reportFiles          : 'index.html',
                reportName           : 'Jacoco Coverage Report'
        ]
    }

    stage("BDD - Cucumber") {
        sh "./gradlew test --tests \"*CucumberTest*\""
    }

    stage("Mutation Testing - Pitest") {
        try {
            sh "./gradlew pitest"
        } catch (err) {
            step([$class: 'JUnitResultArchiver', testResults:
                    '**/target/surefire-reports/TEST-*UnitTest.xml'])
            throw err
        }
    }
}
