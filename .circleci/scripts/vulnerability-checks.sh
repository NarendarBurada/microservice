#!/usr/bin/env bash
echo "Trivy Vulnerabilities Check Begins.."
apt-get update
echo "Installing Trivy"
apt-get -y install wget apt-transport-https gnupg lsb-release
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | tee -a /etc/apt/sources.list.d/trivy.list
apt-get update
export DEBIAN_FRONTEND=noninteractive
apt-get -y install trivy
echo "Trivy Installation completed and starting checking vulnerabilities...."
TAG="latest"
critical_vulnerability=$(trivy -s CRITICAL ${DOCKER_USER}/${PRODUCT}:${TAG} | grep Total | sed "s/Total: //g" | cut -c1-1)
echo "Total Critical vulnerabilities"
echo $critical_vulnerability
mkdir reports
trivy "${DOCKER_USER}/${PRODUCT}:${TAG}" >reports/vulnerability-report.txt
echo "Vulnerabilities Report Generated..."
if [ "$critical_vulnerability" != "0" ]; then
  echo -e '\xE2\x98\xA0'
  echo "Critical Vulnerabilities Identified, review the attached vulnerability report"
  echo -e '\xE2\x98\xA0'
  echo "Fix the CRITICAL vulnerabilities to proceed with the deployment in the attached report"
  echo -e '\xE2\x98\xA0'
  exit 1
else
  echo -e '\xE2\x98\xA0'
  echo "Everything is good"
  echo -e '\xE2\x98\xA0'
  echo "No Critical Vulnerabilities Identified, review reports of other vulnerabilities identified"
  echo -e '\xE2\x98\xA0'
fi
echo "Trivy Vulnerabilities Check Ends.."
