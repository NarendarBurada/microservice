#!/usr/bin/env bash
# Declaring the functions
emojiFunction() {
  for i in {1..95}; do
    printf $1
  done
  printf '\n'
}
echo "Starting checking vulnerabilities...."
TAG="latest"
critical_vulnerability=$(trivy -s CRITICAL ${DOCKER_USER}/${PRODUCT}:${TAG} | grep Total | sed "s/Total: //g" | cut -c1-1)
echo "Total Critical vulnerabilities"
echo $critical_vulnerability
mkdir reports
trivy "${DOCKER_USER}/${PRODUCT}:${TAG}" >reports/vulnerability-report.txt
echo "Vulnerabilities Report Generated..."
if [ "$critical_vulnerability" != "0" ]; then
  emojiFunction "\xE2\x98\xA0"
  echo "Critical Vulnerabilities Identified, review the attached vulnerability report."
  echo "Fix the CRITICAL vulnerabilities to proceed with the deployment."
  emojiFunction "\xE2\x98\xA0"
  exit 1
else
  emojiFunction "\xE2\x99\xA0"
  echo "Everything is good."
  echo "No Critical Vulnerabilities Identified, review full list of other vulnerabilities identified."
  emojiFunction "\xE2\x99\xA0"
fi
echo "Trivy Vulnerabilities Check Ends.."
